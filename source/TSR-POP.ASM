; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ
; Perfect Interrupt with Screen Buffering v1.0
; --------------------------------------------
; Author     : AM
; Copyright  : TMB Productions
; Year       : 2000
;

.386

TMBLoader       Segment Byte Public Use16
                Assume  CS:TMBLoader, DS:TMBLoader


                Org     100h


Start:
        Mov     SP, Offset StackArea + 200h     ; 200h byte stack for setup
        Jmp     LoaderStart


;       ------- Values which stays resident ---------------
PSPseg          DW  ?                           ; ES at the beginning of
                                                ; execution
OldInt1Ch       DD  ?                           ; This is called by timer
                                                ; interrupt 8 (IRQ 0)
Other_Stack     DD  ?                           ; Save stack SS:SP here
Our_Stack       DD  ?

ValueCheck1     EQU 0FED8h
ValueCheck2     EQU 0D7h

ThePopUpKey     EQU 78







Int_1Ch         PROC    FAR
        Cmp     AH, ValueCheck2
        Je      Short Its_Ours
        Jmp     MoveOn

Its_Ours:
        Mov     AX, ValueCheck1
        Mov     BX, CS:PSPseg                   ; Grab PSP segment
        Mov     CX, CS
        Clc
        IRet                                    ; Or 'RetF 2'


MoveOn:
        Cli

        Mov     Word Ptr CS:Other_Stack + 2, SS ; Save old stack
        Mov     Word Ptr CS:Other_Stack, SP
        Lss     SP, CS:Our_Stack                ; Replace it with our stack

        PushF
        Push    AX
        Push    BX
        Push    CX
        Push    DX
        Push    DI
        Push    SI
        Push    DS
        Push    ES
        Cld

        In      AL, 60h
        Cmp     AL, ThePopUpKey
        Jne     JustQuit

        Mov     AH, ThePopUpKey
        Call    ReleaseKey


;       ------- Begin without erasing anything ------------
        Mov     AX, CS
        Mov     ES, AX
        Mov     DS, AX

        In      AL, 21h
        XChg    AL, AH
        In      AL, 0A1h
        Push    AX

        Mov     AL, 0FEh
        Out     21h, AL
        Mov     AL, 0FFh
        Out     0A1h, AL

        Mov     BX, Offset CS:OldState
        Mov     CX, 0007h
        Mov     AX, 1C01h
        Int     10h
        Call    ModifyScreen

;       ------- Save old Text screen ----------------------
        Push    DS
        Mov     AX, 0B800h
        Mov     DS, AX
        Xor     SI, SI
        Mov     CX, 1000h
        Mov     DI, Offset CS:OldScreen
        Rep     MovsW
        Pop     DS


        Mov     AH, 0Fh
        Int     10h
        Xor     AH, AH
        Push    AX

        Mov     AL, 83h
        Int     10h



;       ------- Here is the menu code ---------------------
        Call    ShowPicture

        Mov     AL, 0Ah                     ; Index [cursor]
        Mov     AH, 100000b                 ; Bit 5 (6) [cursor 0=on 1=off]
        Mov     DX, 3D4h                    
        Out     DX, AX                      

GetKeyLoop:
        In      AL, 60h
        Cmp     AL, ThePopUpKey
        Jne     GetKeyLoop

        Mov     AH, ThePopUpKey
        Call    ReleaseKey

        Call    ShowPicture



;       ------- Quit in a decently way --------------------
        Pop     AX
        Or      AL, 80h
        Int     10h
        Call    ModifyScreen


;       ------- Restore text screen -----------------------
        Push    ES
        Mov     AX, 0B800h
        Mov     ES, AX
        Xor     DI, DI
        Mov     CX, 1000h
        Mov     SI, Offset CS:OldScreen
        Rep     MovsW                           ; Copy DS:DI => ES:SI
        Pop     ES

        Mov     BX, Offset CS:OldState
        Mov     CX, 0007h
        Mov     AX, 1C02h
        Int     10h

        Pop     AX
        Out     0A1h, AL
        XChg    AL, AH
        Out     21h, AL


JustQuit:
        Pop     ES
        Pop     DS
        Pop     SI
        Pop     DI
        Pop     DX
        Pop     CX
        Pop     BX
        Pop     AX
        PopF


QuitInterrupt:
        Lss     SP, CS:Other_Stack              ; Restore old stack
        Sti                                     ; Enable interrupts
        Jmp     DWord Ptr CS:OldInt1Ch          ; Jump to original interrupt


ReleaseKey:
        In      AL, 60h
        Cmp     AL, AH
        Je      ReleaseKey
        RetN

ModifyScreen:
        Mov     DX, 03C4h
        Mov     AX, 0402h
        Out     DX, AX
        Mov     DL, 0CEh
        Mov     AX, 0FF08h
        Out     DX, AX
        Mov     DL, 0C4h
        Mov     AX, 0704h
        Out     DX, AX
        Mov     DL, 0CEh
        Mov     AX, 0C06h
        Out     DX, AX
        Mov     AX, 0204h
        Out     DX, AX
        Mov     AX, 0005h
        Out     DX, AX
        RetN

;       ------- Uses a form of XOR saving/loading ---------
ShowPicture:
        Push    ES
        Mov     AX, 0B800h
        Mov     ES, AX
        Xor     DI, DI
        Mov     SI, Offset CS:CoolPicture
        Mov     CX, (80 * 25)           ; Please note :
                                        ; A Text page is really :
                                        ; (((80 * 26) * 2) - 64) in size
SPicLoop:
        LodsW
        XChg    AX, ES:[DI]
        Inc     DI
        Inc     DI
        Mov     [SI - 0002], AX
        Loop    SPicLoop
        Pop     ES
        RetN


OldState        DB  950 Dup (0)
OldScreen       DW  1000h Dup (0)

;       ------- Works like :  Chr, Colour
;                             '         '
CoolPicture:
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,'Ú',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'¿',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,'³',15,' ',15,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,'L',31,'o',31,'l',31
        DB      'l',31,'y',31,' ',31,'P',31,'o',31,'p',31,' ',31,'T',31
        DB      'r',31,'a',31,'i',31,'n',31,'e',31,'r',31,' ',31,'v',31
        DB      '1',31,'.',31,'0',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',15,'³',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      'Ú',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ù',15,' ',15,' ',31,' ',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,' ',31,' ',31,' ',15,'À',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'¿',15
        DB      '³',15,' ',15,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'ú',31
        DB      ' ',31,'C',31,'o',31,'p',31,'y',31,'r',31,'i',31,'g',31
        DB      'h',31,'t',31,' ',31,'2',31,'0',31,'0',31,'0',31,' ',31
        DB      'T',31,'M',31,'B',31,' ',31,'P',31,'r',31,'o',31,'d',31
        DB      'u',31,'c',31,'t',31,'i',31,'o',31,'n',31,'s',31,' ',31
        DB      'ú',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'Ú',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'¿',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'Ú',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'¿',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,30,31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31,'Ã',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'´',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31,'³',31
        DB      ' ',31,'T',31,'r',31,'a',31,'i',31,'n',31,'e',31,'d',31
        DB      ' ',31,'b',31,'y',31,' ',31,':',31,' ',31,' ',31,'A',31
        DB      'M',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31,'³',31
        DB      ' ',31,'C',31,'o',31,'p',31,'y',31,'r',31,'i',31,'g',31
        DB      'h',31,'t',31,' ',31,' ',31,':',31,' ',31,' ',31,'T',31
        DB      'M',31,'B',31,' ',31,'P',31,'r',31,'o',31,'d',31,'u',31
        DB      'c',31,'t',31,'i',31,'o',31,'n',31,'s',31,' ',31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31,'³',31
        DB      ' ',31,'D',31,'a',31,'t',31,'e',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,':',31,' ',31,' ',31,'D',31
        DB      'D',31,'/',31,'M',31,'M',31,'/',31,'Y',31,'Y',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31,'Ã',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'´',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'³',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,31,31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'³',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,'³',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,'À',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ù',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,'À',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ù',31,' ',31,' ',15,'³',15
        DB      '³',15,' ',15,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',31
        DB      ' ',31,' ',31,' ',31,' ',31,' ',31,' ',31,' ',15,'³',15
        DB      'À',15,'Ä',15,'Ä',15,'Ä',15,'Â',15,'Ä',15,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31,'Ä',31
        DB      'Ä',31,'Ä',31,'Ä',15,'Â',15,'Ä',15,'Ä',15,'Ä',15,'Ù',15
        DB      ' ',15,' ',15,' ',15,' ',15,'À',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15,'Ä',15
        DB      'Ä',15,'Ä',15,'Ä',15,'Ù',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
        DB      ' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15,' ',15
Int_1Ch         ENDP

        DB      140 Dup (?)                     ; Our stack space
The_Stack:                                      ; The stack goes 'Up'


;       ------- The end of code which is stored as TSR ----
EndOfResidentCode:













;       ---------------------------------------------------
;       The startup/ end code
;       ---------------------------------------------------
LoaderStart:
        Mov     AX, CS                          ; Actually in the beginning
        Mov     DS, AX                          ; of EVERY Com file CS=DS=ES
        Mov     PSPseg, ES                      ; Save our Segment for later

;       ------- Save our stack ----------------------------
        Mov     Word Ptr Our_Stack, Offset The_Stack
        Mov     Word Ptr Our_Stack + 2, CS
    

;       ------- Check if the TSR is already installed -----
        Mov     AH, ValueCheck2
        Int     1Ch
        Jc      Short Install
        Cmp     AX, ValueCheck1
        Jne     Short Install


;       ------- Remove our TSR from memory ----------------
;       From the 1Ch Interrupt we got: BX = Old Segment when we installed
;                                      CX = CS Segment when we interrupted
RemoveTSR:
        Push    BX                              ; BX = PSPseg of other guy
        Push    DS

        Mov     DS, CX                          ; DS = other guys CS

        Mov     BX, 1Ch
        Mov     DI, Offset OldInt1Ch

;       ------- Beginning of restore routine --------------
        Push    ES
        Push    ECX
        Push    BX
        Xor     CX, CX
        Mov     ES, CX
        Shl     BX, 2
        Cli
        Mov     ECX, [DI]                       ; Grab old SAVED int
        Mov     ES:[BX], ECX                    ; Restore it
        Sti
        Pop     BX
        Pop     ECX
        Pop     ES
;       ------- End of restore routine --------------------

        Pop     DS
        Pop     ES
                                                ; Remember: BX is STILL = PSP
        Mov     AH, 49h                         ; Now we release THAT segment
        Int     21h

;       ---------------------------------------------------

        Mov     DX, Offset TextRemoved
        Call    PrintText

        Mov     AX, 4C00h
        Int     21h








Install:
;       ------- Release the memory Command.com gave us ----
        Mov     ES, CS:2Ch              ; Get segment of Environment block
                                        ; The 2Ch is the offset in the PSP
                                        ; segment which points to the
                                        ; Environment Block Segment of
                                        ; THIS program.
        Mov     AH, 49h
        Int     21h                     ; Release it (WE DON'T NEED IT)


;       ------- Set new interrupts ------------------------
        Mov     AX, CS
        Mov     DS, AX

        Mov     BX, 1Ch
        Mov     DI, Offset OldInt1ch
        Mov     DX, Offset Int_1ch

;       ------- Start of Install interrupt routine --------
        Push    ES
        Push    ECX
        Push    BX
        Xor     CX, CX
        Mov     ES, CX
        Shl     BX, 2
        Mov     ECX, ES:[BX]                    ; Get old interrupt
        Mov     [DI], ECX                       ; Save it
        Cli
        Mov     Word Ptr ES:[bx], DX            ; Store new int
        Mov     Word Ptr ES:[bx+2], DS
        Sti
        Pop     BX
        Pop     ECX
        Pop     ES
;       ------- End of Install interrupt routine ----------



        Mov     DX, Offset TextInstalled
        Call    PrintText

        Mov     DX, Offset EndOfResidentCode
        Shr     DX, 4                           ; Convert to Paragraphs
        Inc     DX
        Mov     AX, 3100h                       ; Keep the program in mem
        Int     21h             ; al = return code, dx = paragraphs to keep




;       ------- Values for temporary use ------------------
TextInstalled   DB  '      The TSR was successfully installed.', 13, 10, 10
                DB  '              Press + for pop up', 13, 10, 10
                DB  'Run this program again to remove it from memory', 13, 10
                DB  13, 10
                DB  '$'
TextRemoved     DB  'TSR is now removed from memory'
                DB  13, 10
                DB  '$'



;       ------- Sub functions - Not resident --------------
PrintText:
        Push    AX
        Mov     AX, CS
        Mov     DS, AX
        Mov     AH, 9
        Int     21h
        Pop     AX
        RetN





StackArea:                                      ; Stack for initialization



TMBLoader       EndS



        End     Start
